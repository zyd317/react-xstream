"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var index_1 = require("../index");
var FCAMIL = /** @class */ (function () {
    function FCAMIL(out, op) {
        this.out = out;
        this.op = op;
    }
    FCAMIL.prototype._n = function (t) {
        this.out._n(t);
    };
    FCAMIL.prototype._e = function (err) {
        this.out._e(err);
    };
    FCAMIL.prototype._c = function () {
        this.op.less();
    };
    return FCAMIL;
}());
var FlattenConcAMOperator = /** @class */ (function () {
    function FlattenConcAMOperator(n, ins) {
        this.n = n;
        this.ins = ins;
        this.type = 'flattenConcurrentlyAtMost';
        this.out = null;
        this._l = 0;
        this._d = false;
        this._seq = [];
    }
    FlattenConcAMOperator.prototype._start = function (out) {
        this.out = out;
        this.ins._add(this);
    };
    FlattenConcAMOperator.prototype._stop = function () {
        this.ins._remove(this);
        this._l = 0;
        this.out = null;
        this._seq = [];
    };
    FlattenConcAMOperator.prototype.less = function () {
        var seq = this._seq;
        if (--this._l === 0 && seq.length === 0 && this._d) {
            var u = this.out;
            if (!u)
                return;
            u._c();
        }
        if (this._l < this.n && seq.length > 0) {
            this._n(seq.shift());
        }
    };
    FlattenConcAMOperator.prototype._n = function (s) {
        var u = this.out;
        if (!u)
            return;
        if (this._l < this.n) {
            this._l++;
            s._add(new FCAMIL(u, this));
        }
        else {
            this._seq.push(s);
        }
    };
    FlattenConcAMOperator.prototype._e = function (err) {
        var u = this.out;
        if (!u)
            return;
        u._e(err);
    };
    FlattenConcAMOperator.prototype._c = function () {
        var seq = this._seq;
        this._d = true;
        if (this._l === 0 && seq.length === 0) {
            var u = this.out;
            if (!u)
                return;
            u._c();
        }
    };
    return FlattenConcAMOperator;
}());
exports.FlattenConcAMOperator = FlattenConcAMOperator;
/**
 * Flattens a "stream of streams", handling multiple concurrent nested streams
 * simultaneously, up to some limit `n`.
 *
 * If the input stream is a stream that emits streams, then this operator will
 * return an output stream which is a flat stream: emits regular events. The
 * flattening happens concurrently, up to the configured limit. It works like
 * this: when the input stream emits a nested stream,
 * *flattenConcurrentlyAtMost* will start imitating that nested one. When the
 * next nested stream is emitted on the input stream,
 * *flattenConcurrentlyAtMost* will check to see how many streams it is connected
 * to. If it is connected to a number of streams less than the limit, it will also
 * imitate that new one, but will continue to imitate the previous nested streams
 * as well.
 *
 * If the limit has already been reached, *flattenConcurrentlyAtMost* will put the
 * stream in a queue. When any of the streams it is listening to completes, a stream
 * is taken out of the queue and `flattenConcurrentlyAtMost` will connect to it.
 *
 * This process continues until the metastream completes and there are no more
 * connected streams or streams in the queue.
 *
 * Marble diagrams:
 *
 * ```text
 * --+--------+---------------
 *   \        \
 *    \       ----1----2---3--|
 *    --a--b----c----|
 *     flattenConcurrentlyAtMost(1)
 * -----a--b----c-1----2---3--|
 * ```
 *
 * ```text
 * --+---+---+-|
 *    \   \   \
 *     \   \   ---fgh----i-----jh--|
 *      \   -----1----2----3--|
 *       ---a--b-----c--|
 *     flattenConcurrentlyAtMost(2)
 * ---------a--b-1---c2--i-3------fgh----i-----jh--|
 * ```
 *
 * @return {Stream}
 */
function flattenConcurrentlyAtMost(n) {
    return function flattenConcAMOperator(ins) {
        return new index_1.Stream(new FlattenConcAMOperator(n, ins));
    };
}
exports.default = flattenConcurrentlyAtMost;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdHRlbkNvbmN1cnJlbnRseUF0TW9zdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9leHRyYS9mbGF0dGVuQ29uY3VycmVudGx5QXRNb3N0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsa0NBQXVFO0FBRXZFO0lBQ0UsZ0JBQW1CLEdBQWMsRUFDYixFQUE0QjtRQUQ3QixRQUFHLEdBQUgsR0FBRyxDQUFXO1FBQ2IsT0FBRSxHQUFGLEVBQUUsQ0FBMEI7SUFDaEQsQ0FBQztJQUVELG1CQUFFLEdBQUYsVUFBRyxDQUFJO1FBQ0wsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakIsQ0FBQztJQUVELG1CQUFFLEdBQUYsVUFBRyxHQUFRO1FBQ1QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDbkIsQ0FBQztJQUVELG1CQUFFLEdBQUY7UUFDRSxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFDSCxhQUFDO0FBQUQsQ0FBQyxBQWhCRCxJQWdCQztBQUVEO0lBT0UsK0JBQW1CLENBQVMsRUFBUyxHQUFzQjtRQUF4QyxNQUFDLEdBQUQsQ0FBQyxDQUFRO1FBQVMsUUFBRyxHQUFILEdBQUcsQ0FBbUI7UUFOcEQsU0FBSSxHQUFHLDJCQUEyQixDQUFDO1FBQ25DLFFBQUcsR0FBYyxJQUFXLENBQUM7UUFDNUIsT0FBRSxHQUFXLENBQUMsQ0FBQztRQUNmLE9BQUUsR0FBWSxLQUFLLENBQUM7UUFDcEIsU0FBSSxHQUFxQixFQUFFLENBQUM7SUFHcEMsQ0FBQztJQUVELHNDQUFNLEdBQU4sVUFBTyxHQUFjO1FBQ25CLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEIsQ0FBQztJQUVELHFDQUFLLEdBQUw7UUFDRSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNaLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBVyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFFRCxvQ0FBSSxHQUFKO1FBQ0UsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN0QixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsS0FBSyxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNsRCxJQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQ25CLElBQUksQ0FBQyxDQUFDO2dCQUFFLE9BQU87WUFDZixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7U0FDUjtRQUNELElBQUksSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3RDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBZSxDQUFDLENBQUM7U0FDbkM7SUFDSCxDQUFDO0lBRUQsa0NBQUUsR0FBRixVQUFHLENBQVk7UUFDYixJQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBQ25CLElBQUksQ0FBQyxDQUFDO1lBQUUsT0FBTztRQUNmLElBQUksSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNWLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDN0I7YUFBTTtZQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ25CO0lBQ0gsQ0FBQztJQUVELGtDQUFFLEdBQUYsVUFBRyxHQUFRO1FBQ1QsSUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztRQUNuQixJQUFJLENBQUMsQ0FBQztZQUFFLE9BQU87UUFDZixDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ1osQ0FBQztJQUVELGtDQUFFLEdBQUY7UUFDRSxJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ2YsSUFBSSxJQUFJLENBQUMsRUFBRSxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNyQyxJQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQ25CLElBQUksQ0FBQyxDQUFDO2dCQUFFLE9BQU87WUFDZixDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7U0FDUjtJQUNILENBQUM7SUFDSCw0QkFBQztBQUFELENBQUMsQUE1REQsSUE0REM7QUE1RFksc0RBQXFCO0FBOERsQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0E0Q0c7QUFDSCxTQUF3Qix5QkFBeUIsQ0FBSSxDQUFTO0lBQzVELE9BQU8sU0FBUyxxQkFBcUIsQ0FBQyxHQUFzQjtRQUMxRCxPQUFPLElBQUksY0FBTSxDQUFJLElBQUkscUJBQXFCLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDMUQsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUpELDRDQUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtPcGVyYXRvciwgU3RyZWFtLCBPdXRTZW5kZXIsIEludGVybmFsTGlzdGVuZXJ9IGZyb20gJy4uL2luZGV4JztcblxuY2xhc3MgRkNBTUlMPFQ+IGltcGxlbWVudHMgSW50ZXJuYWxMaXN0ZW5lcjxUPiwgT3V0U2VuZGVyPFQ+IHtcbiAgY29uc3RydWN0b3IocHVibGljIG91dDogU3RyZWFtPFQ+LFxuICAgICAgICAgICAgICBwcml2YXRlIG9wOiBGbGF0dGVuQ29uY0FNT3BlcmF0b3I8VD4pIHtcbiAgfVxuXG4gIF9uKHQ6IFQpIHtcbiAgICB0aGlzLm91dC5fbih0KTtcbiAgfVxuXG4gIF9lKGVycjogYW55KSB7XG4gICAgdGhpcy5vdXQuX2UoZXJyKTtcbiAgfVxuXG4gIF9jKCkge1xuICAgIHRoaXMub3AubGVzcygpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBGbGF0dGVuQ29uY0FNT3BlcmF0b3I8VD4gaW1wbGVtZW50cyBPcGVyYXRvcjxTdHJlYW08VD4sIFQ+IHtcbiAgcHVibGljIHR5cGUgPSAnZmxhdHRlbkNvbmN1cnJlbnRseUF0TW9zdCc7XG4gIHB1YmxpYyBvdXQ6IFN0cmVhbTxUPiA9IG51bGwgYXMgYW55O1xuICBwcml2YXRlIF9sOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIF9kOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgX3NlcTogQXJyYXk8U3RyZWFtPFQ+PiA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBuOiBudW1iZXIsIHB1YmxpYyBpbnM6IFN0cmVhbTxTdHJlYW08VD4+KSB7XG4gIH1cblxuICBfc3RhcnQob3V0OiBTdHJlYW08VD4pOiB2b2lkIHtcbiAgICB0aGlzLm91dCA9IG91dDtcbiAgICB0aGlzLmlucy5fYWRkKHRoaXMpO1xuICB9XG5cbiAgX3N0b3AoKTogdm9pZCB7XG4gICAgdGhpcy5pbnMuX3JlbW92ZSh0aGlzKTtcbiAgICB0aGlzLl9sID0gMDtcbiAgICB0aGlzLm91dCA9IG51bGwgYXMgYW55O1xuICAgIHRoaXMuX3NlcSA9IFtdO1xuICB9XG5cbiAgbGVzcygpOiB2b2lkIHtcbiAgICBjb25zdCBzZXEgPSB0aGlzLl9zZXE7XG4gICAgaWYgKC0tdGhpcy5fbCA9PT0gMCAmJiBzZXEubGVuZ3RoID09PSAwICYmIHRoaXMuX2QpIHtcbiAgICAgIGNvbnN0IHUgPSB0aGlzLm91dDtcbiAgICAgIGlmICghdSkgcmV0dXJuO1xuICAgICAgdS5fYygpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fbCA8IHRoaXMubiAmJiBzZXEubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5fbihzZXEuc2hpZnQoKSBhcyBTdHJlYW08VD4pO1xuICAgIH1cbiAgfVxuXG4gIF9uKHM6IFN0cmVhbTxUPikge1xuICAgIGNvbnN0IHUgPSB0aGlzLm91dDtcbiAgICBpZiAoIXUpIHJldHVybjtcbiAgICBpZiAodGhpcy5fbCA8IHRoaXMubikge1xuICAgICAgdGhpcy5fbCsrO1xuICAgICAgcy5fYWRkKG5ldyBGQ0FNSUwodSwgdGhpcykpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9zZXEucHVzaChzKTtcbiAgICB9XG4gIH1cblxuICBfZShlcnI6IGFueSkge1xuICAgIGNvbnN0IHUgPSB0aGlzLm91dDtcbiAgICBpZiAoIXUpIHJldHVybjtcbiAgICB1Ll9lKGVycik7XG4gIH1cblxuICBfYygpIHtcbiAgICBjb25zdCBzZXEgPSB0aGlzLl9zZXE7XG4gICAgdGhpcy5fZCA9IHRydWU7XG4gICAgaWYgKHRoaXMuX2wgPT09IDAgJiYgc2VxLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc3QgdSA9IHRoaXMub3V0O1xuICAgICAgaWYgKCF1KSByZXR1cm47XG4gICAgICB1Ll9jKCk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogRmxhdHRlbnMgYSBcInN0cmVhbSBvZiBzdHJlYW1zXCIsIGhhbmRsaW5nIG11bHRpcGxlIGNvbmN1cnJlbnQgbmVzdGVkIHN0cmVhbXNcbiAqIHNpbXVsdGFuZW91c2x5LCB1cCB0byBzb21lIGxpbWl0IGBuYC5cbiAqXG4gKiBJZiB0aGUgaW5wdXQgc3RyZWFtIGlzIGEgc3RyZWFtIHRoYXQgZW1pdHMgc3RyZWFtcywgdGhlbiB0aGlzIG9wZXJhdG9yIHdpbGxcbiAqIHJldHVybiBhbiBvdXRwdXQgc3RyZWFtIHdoaWNoIGlzIGEgZmxhdCBzdHJlYW06IGVtaXRzIHJlZ3VsYXIgZXZlbnRzLiBUaGVcbiAqIGZsYXR0ZW5pbmcgaGFwcGVucyBjb25jdXJyZW50bHksIHVwIHRvIHRoZSBjb25maWd1cmVkIGxpbWl0LiBJdCB3b3JrcyBsaWtlXG4gKiB0aGlzOiB3aGVuIHRoZSBpbnB1dCBzdHJlYW0gZW1pdHMgYSBuZXN0ZWQgc3RyZWFtLFxuICogKmZsYXR0ZW5Db25jdXJyZW50bHlBdE1vc3QqIHdpbGwgc3RhcnQgaW1pdGF0aW5nIHRoYXQgbmVzdGVkIG9uZS4gV2hlbiB0aGVcbiAqIG5leHQgbmVzdGVkIHN0cmVhbSBpcyBlbWl0dGVkIG9uIHRoZSBpbnB1dCBzdHJlYW0sXG4gKiAqZmxhdHRlbkNvbmN1cnJlbnRseUF0TW9zdCogd2lsbCBjaGVjayB0byBzZWUgaG93IG1hbnkgc3RyZWFtcyBpdCBpcyBjb25uZWN0ZWRcbiAqIHRvLiBJZiBpdCBpcyBjb25uZWN0ZWQgdG8gYSBudW1iZXIgb2Ygc3RyZWFtcyBsZXNzIHRoYW4gdGhlIGxpbWl0LCBpdCB3aWxsIGFsc29cbiAqIGltaXRhdGUgdGhhdCBuZXcgb25lLCBidXQgd2lsbCBjb250aW51ZSB0byBpbWl0YXRlIHRoZSBwcmV2aW91cyBuZXN0ZWQgc3RyZWFtc1xuICogYXMgd2VsbC5cbiAqXG4gKiBJZiB0aGUgbGltaXQgaGFzIGFscmVhZHkgYmVlbiByZWFjaGVkLCAqZmxhdHRlbkNvbmN1cnJlbnRseUF0TW9zdCogd2lsbCBwdXQgdGhlXG4gKiBzdHJlYW0gaW4gYSBxdWV1ZS4gV2hlbiBhbnkgb2YgdGhlIHN0cmVhbXMgaXQgaXMgbGlzdGVuaW5nIHRvIGNvbXBsZXRlcywgYSBzdHJlYW1cbiAqIGlzIHRha2VuIG91dCBvZiB0aGUgcXVldWUgYW5kIGBmbGF0dGVuQ29uY3VycmVudGx5QXRNb3N0YCB3aWxsIGNvbm5lY3QgdG8gaXQuXG4gKlxuICogVGhpcyBwcm9jZXNzIGNvbnRpbnVlcyB1bnRpbCB0aGUgbWV0YXN0cmVhbSBjb21wbGV0ZXMgYW5kIHRoZXJlIGFyZSBubyBtb3JlXG4gKiBjb25uZWN0ZWQgc3RyZWFtcyBvciBzdHJlYW1zIGluIHRoZSBxdWV1ZS5cbiAqXG4gKiBNYXJibGUgZGlhZ3JhbXM6XG4gKlxuICogYGBgdGV4dFxuICogLS0rLS0tLS0tLS0rLS0tLS0tLS0tLS0tLS0tXG4gKiAgIFxcICAgICAgICBcXFxuICogICAgXFwgICAgICAgLS0tLTEtLS0tMi0tLTMtLXxcbiAqICAgIC0tYS0tYi0tLS1jLS0tLXxcbiAqICAgICBmbGF0dGVuQ29uY3VycmVudGx5QXRNb3N0KDEpXG4gKiAtLS0tLWEtLWItLS0tYy0xLS0tLTItLS0zLS18XG4gKiBgYGBcbiAqXG4gKiBgYGB0ZXh0XG4gKiAtLSstLS0rLS0tKy18XG4gKiAgICBcXCAgIFxcICAgXFxcbiAqICAgICBcXCAgIFxcICAgLS0tZmdoLS0tLWktLS0tLWpoLS18XG4gKiAgICAgIFxcICAgLS0tLS0xLS0tLTItLS0tMy0tfFxuICogICAgICAgLS0tYS0tYi0tLS0tYy0tfFxuICogICAgIGZsYXR0ZW5Db25jdXJyZW50bHlBdE1vc3QoMilcbiAqIC0tLS0tLS0tLWEtLWItMS0tLWMyLS1pLTMtLS0tLS1mZ2gtLS0taS0tLS0tamgtLXxcbiAqIGBgYFxuICpcbiAqIEByZXR1cm4ge1N0cmVhbX1cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gZmxhdHRlbkNvbmN1cnJlbnRseUF0TW9zdDxUPihuOiBudW1iZXIpOiAoaW5zOiBTdHJlYW08U3RyZWFtPFQ+PikgPT4gU3RyZWFtPFQ+IHtcbiAgcmV0dXJuIGZ1bmN0aW9uIGZsYXR0ZW5Db25jQU1PcGVyYXRvcihpbnM6IFN0cmVhbTxTdHJlYW08VD4+KSB7XG4gICAgcmV0dXJuIG5ldyBTdHJlYW08VD4obmV3IEZsYXR0ZW5Db25jQU1PcGVyYXRvcihuLCBpbnMpKTtcbiAgfTtcbn1cbiJdfQ==